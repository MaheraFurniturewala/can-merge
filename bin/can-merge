#!/usr/bin/env node

'use strict';

const Yargs = require('yargs');
const chalk = require('chalk');
require('dotenv').config();
const getRepo = require('../utils/getRepo');
const getSHA = require('../utils/getSHA');

const runQuery = require('../utils/runQuery');
const evaluatePullRequest = require('../utils/evaluatePullRequest');
const logger = require('../utils/logger');
const parsePullRequest = require('../utils/parsePullRequest');
const pullRequestStatus = require('../utils/models/pullRequestStatus');

const {
	GITHUB_TOKEN,
	GH_TOKEN,
	NODE_ENV,
} = process.env;

const args = Yargs
	.usage('Usage: can-merge -p <pr> [-r <repo>]')
	.help()
	.strict()
	.options({
		pr: {
			alias: 'p',
			demandOption: false,
			describe: 'pull request',
			type: 'string',
		},
		repo: {
			alias: 'r',
			'default': getRepo(),
			demandOption: !getRepo(),
			describe: 'repository',
			type: 'string',
		},
		sha: {
			alias: 's',
			'default': getSHA(),
			describe: 'commit SHA',
			type: 'string',
		},
		token: {
			alias: 't',
			demandOption: !(GITHUB_TOKEN || GH_TOKEN),
			describe: 'github access token',
			type: 'string',
		},
	})
	.parse();

const token = args.token || GITHUB_TOKEN || GH_TOKEN;

runQuery(args.repo, args.pr, token).then((response) => {
	if (NODE_ENV === 'DEBUG') {
		console.log(JSON.stringify(response, null, 2));
	}
	const prs = parsePullRequest(response.repository);
	if (prs.length === 0) {
		console.info(chalk.redBright(`âš  This repository does not contain any pull requests matching ${args.sha}`));
		process.exitCode = 1;
	} else {
		prs.forEach((pr) => {
			const status = evaluatePullRequest(pr);
			console.info('PR:', pr.number, logger(status));
			if (status !== pullRequestStatus.MERGEABLE) {
				process.exitCode = (process.exitCode ?? 0) + 1;
			}
		});
	}
});

